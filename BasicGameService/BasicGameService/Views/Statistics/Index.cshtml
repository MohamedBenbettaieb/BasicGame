@model BasicGameService.Models.Stats.StatisticsViewModel
@{
    ViewData["Title"] = "Statistics";
    // Prepare JSON for charts
    var deviceLabels = System.Text.Json.JsonSerializer.Serialize(Model.DeviceStats.Select(d => d.DeviceName));
    var deviceTimes = System.Text.Json.JsonSerializer.Serialize(Model.DeviceStats.Select(d => d.TimesUsed));
    var deviceTotalMinutes = System.Text.Json.JsonSerializer.Serialize(Model.DeviceStats.Select(d => Math.Round(d.TotalTimeMinutes, 1)));
    var gameLabels = System.Text.Json.JsonSerializer.Serialize(Model.GameStats.Select(g => g.GameName));
    var gamePlays = System.Text.Json.JsonSerializer.Serialize(Model.GameStats.Select(g => g.TimesPlayed));
}

<h1>Usage Statistics</h1>

<div class="row">
    <div class="col-md-6">
        <h3>Devices (times used)</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="devicesBarChart"></canvas>
        </div>
        <p class="small text-muted mt-2">Bar chart of how many times each device was used.</p>
    </div>
    <div class="col-md-6">
        <h3>Games (times played)</h3>
        <div style="position: relative; height: 300px;">
            <canvas id="gamesPieChart"></canvas>
        </div>
        <p class="small text-muted mt-2">Pie chart of game popularity.</p>
    </div>
</div>

<hr />

<h2>Devices</h2>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Device</th>
            <th>Times Used</th>
            <th>Total Time (min)</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var d in Model.DeviceStats)
        {
            <tr>
                <td>@d.DeviceName</td>
                <td>@d.TimesUsed</td>
                <td>@Math.Round(d.TotalTimeMinutes, 1)</td>
            </tr>
        }
    </tbody>
</table>

<h2>Games</h2>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Game</th>
            <th>Times Played</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var g in Model.GameStats)
        {
            <tr>
                <td>@g.GameName</td>
                <td>@g.TimesPlayed</td>
            </tr>
        }
    </tbody>
</table>

<a asp-controller="Admin" asp-action="Index" class="btn btn-secondary">Back to Dashboard</a>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const deviceLabels = @Html.Raw(deviceLabels);
        const deviceTimes = @Html.Raw(deviceTimes);
        const deviceTotalMinutes = @Html.Raw(deviceTotalMinutes);
        const gameLabels = @Html.Raw(gameLabels);
        const gamePlays = @Html.Raw(gamePlays);

        // Devices bar chart
        const ctxDevices = document.getElementById('devicesBarChart').getContext('2d');
        new Chart(ctxDevices, {
            type: 'bar',
            data: {
                labels: deviceLabels,
                datasets: [{
                    label: 'Times Used',
                    data: deviceTimes,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Games pie chart
        const ctxGames = document.getElementById('gamesPieChart').getContext('2d');
        new Chart(ctxGames, {
            type: 'pie',
            data: {
                labels: gameLabels,
                datasets: [{
                    data: gamePlays,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(153, 102, 255, 0.5)',
                        'rgba(255, 159, 64, 0.5)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    </script>
}